#!/usr/bin/env bash

composer install && \
bin/console doctrine:database:drop --force --if-exists && \
bin/console doctrine:database:create && \
bin/console doctrine:schema:update --force && \
bin/console doctrine:fixtures:load -n
[[ $? -ne 0 ]] && echo "Environment setup failed" && exit 1

source .env.dist .env .env.local

if [[ ! -z $ELASTICSEARCH_HOST ]] ; then
    bin/console projection:initialize-types --force && \
    bin/console projection:synchronize
    [[ $? -ne 0 ]] && echo "Projection synchronization failed"
fi

if [[ ! -f config/jwt/private.pem || ! -f config/jwt/public.pem ]] ; then
    openssl genrsa -out config/jwt/private.pem -aes256 4096 && \
    openssl rsa -pubout -in config/jwt/private.pem -out config/jwt/public.pem
    [[ $? -ne 0 ]] && echo "JWT generation failed"
fi
